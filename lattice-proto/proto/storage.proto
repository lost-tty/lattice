syntax = "proto3";

package lattice.storage;

// Hybrid Logical Clock - used throughout
message HLC {
  uint64 wall_time = 1;  // Unix timestamp (ms)
  uint32 counter = 2;    // Logical counter for same-ms ordering
}

// 1. The Wrapper (What flies over the wire and gets stored)
message SignedEntry {
  bytes entry_bytes = 1;  // Serialized Entry message (kept as bytes for stable signature verification)
  bytes signature = 2;    // Ed25519 Signature of entry_bytes
  bytes author_id = 3;    // Public Key of the author (32 bytes)
}

// 2. The Log Entry (The Atomic Unit)
message Entry {
  uint32 version = 1;             // Format version for future evolution
  bytes prev_hash = 2;            // Link to previous sigchain entry (32 bytes)
  uint64 seq = 3;                 // Monotonic sequence number
  HLC timestamp = 4;              // Hybrid Logical Clock
  repeated bytes causal_deps = 7;  // DAG ancestry: hashes of entries this supersedes
  bytes payload = 5;              // Opaque payload (Store implementation determines format)
}

// 5. Per-author state (DB and wire)
message ChainTip {
  uint64 seq = 1;   // Highest sequence number from this author
  bytes hash = 2;   // Hash of last entry (tip of sigchain)
  HLC hlc = 4;      // Highest HLC seen from this author
}

// 6. Log file record
message LogRecord {
  bytes hash = 1;         // BLAKE3 hash of entry_bytes (32 bytes)
  bytes entry_bytes = 2;  // Serialized SignedEntry
}

// 7. Orphan buffer storage
message OrphanedEntry {
  uint64 seq = 1;            // Sequence number of the orphaned entry
  SignedEntry entry = 2;     // The orphaned entry itself
  uint64 received_at = 3;    // Unix timestamp (seconds) when orphan was received
}

// 8. Stored peer sync info (state.db)
message PeerSyncInfo {
  SyncState sync_state = 1;  // Peer's last known sync state
  uint64 updated_at = 2;     // Unix timestamp (seconds) when received
}

// 9. Sync state (shared between storage and network)
message SyncState {
  repeated SyncAuthor authors = 1;  // Per-author sync state
  HLC sender_hlc = 2;               // Sender's current clock
  HLC common_hlc = 3;               // Min of max HLCs across all authors
}

message SyncAuthor {
  bytes author_id = 1;    // Ed25519 public key (32 bytes)
  ChainTip state = 2;  // The author's sync state
}

// 10. Mesh metadata (stored in meta.db)
message MeshInfo {
  uint64 joined_at = 1;    // Unix timestamp (ms) when joined
  bool is_creator = 2;     // Did this node create the mesh?
  // Future fields: alias, sync_priority, etc.
}

// 11. Store metadata (stored in meta.db)
message StoreMetadata {
  bytes mesh_id = 1;       // UUID of the mesh this store belongs to
  uint64 created_at = 2;   // Unix timestamp (ms) when created
  // Future fields: is_root, alias, etc.
}

// --- System Operations (M10A) ---

message UniversalOp {
    oneof op {
        bytes app_data = 10;
        SystemOp system = 11;
    }
}

message SystemOp {
    oneof kind {
        HierarchyOp hierarchy = 1;
        PeerOp peer = 2;
        PeerStrategyOp strategy = 3;
        StoreOp store = 4;
    }
}

message StoreOp {
    oneof op {
        SetStoreName set_name = 1;
    }
}

message SetStoreName {
    string name = 1;
}

// Hierarchy Management
message HierarchyOp {
    oneof op {
        ChildAdd add_child = 1;
        ChildRemove remove_child = 2;
    }
}

message ChildAdd {
    bytes target_id = 1;
    string alias = 2;
}

message ChildRemove {
    bytes target_id = 1;
}

// Peer Management
message PeerOp {
    bytes pubkey = 1;
    oneof op {
        SetPeerStatus set_status = 3;
        SetPeerAddedAt set_added_at = 4;
        SetPeerAddedBy set_added_by = 5;
    }
}

message SetPeerStatus {
    PeerStatus status = 1;
}

message SetPeerAddedAt {
    uint64 timestamp = 1;
}

message SetPeerAddedBy {
    bytes adder_pubkey = 1;
}

enum PeerStatus {
    UNKNOWN = 0;
    INVITED = 1;
    ACTIVE = 2;
    DORMANT = 3;
    REVOKED = 4;
}

// Peer Strategy Management
message PeerStrategyOp {
    oneof op {
        SetPeerStrategy set = 1;
    }
}

message SetPeerStrategy {
    PeerStrategy strategy = 1;
}

message PeerStrategy {
    oneof type {
         bool independent = 1;
         bool inherited = 2;
         bytes snapshot = 3; // UUID bytes
    }
}

// --- HeadList CRDT (Shared) ---

message HeadInfo {
    bytes value = 1;
    lattice.storage.HLC hlc = 2;
    bytes author = 3;
    bytes hash = 4;
    bool tombstone = 5;
}

message HeadList {
    repeated HeadInfo heads = 1;
}
